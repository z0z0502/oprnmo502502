<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±Ø§Ø¬Ø¹ÙŠ Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ù†Ø§Ù†</title>
  <style>
    :root{
      --bg:#1a1a2e; --card:#16213e; --primary:#0b63d6; --muted:#a8a8a8;
      --accent:#06b6d4; --danger:#ef4444; --success:#10b981;
      --text-color:#ffffff; --border-color:#2a3a5a;
      --font-size:16px;
    }
    /* Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© */
    .theme-blue {
      --bg:#1a1a2e; --card:#16213e; --border-color:#2a3a5a;
      --primary:#0b63d6; --accent:#06b6d4;
    }
    .theme-dark {
      --bg:#121212; --card:#1e1e1e; --border-color:#333;
      --primary:#6c63ff; --accent:#ff6584;
    }
    .theme-light {
      --bg:#f5f7fb; --card:#fff; --border-color:#ddd; --text-color:#111;
      --primary:#3a86ff; --accent:#8338ec;
    }
    .theme-green {
      --bg:#1a2e1a; --card:#162e16; --border-color:#2a5a2a;
      --primary:#2a9d8f; --accent:#e9c46a;
    }
    .theme-purple {
      --bg:#2d1a3d; --card:#3a1a4e; --border-color:#4a2a6a;
      --primary:#9c27b0; --accent:#e91e63;
    }
    .theme-gold {
      --bg:#3d2c1a; --card:#4e3a1a; --border-color:#6a4a2a;
      --primary:#ff9800; --accent:#ff5722;
    }
    .theme-ocean {
      --bg:#1a2e3d; --card:#162e4e; --border-color:#2a5a6a;
      --primary:#2196f3; --accent:#00bcd4;
    }
    
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Segoe UI,Arial;
      line-height:1.5;
      background:var(--bg);
      margin:0;
      padding:16px;
      color:var(--text-color);
      min-height:100vh;
      font-size:var(--font-size);
      transition: all 0.3s ease;
    }
    .container{
      max-width:1200px;
      margin:0 auto;
      width:100%;
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
      flex-wrap:wrap;
      position:relative;
    }
    h1{
      font-size:22px;
      margin:0;
      min-width:200px;
    }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      flex:1;
      min-width:300px;
    }
    button{
      background:var(--card);
      border:1px solid var(--border-color);
      padding:10px 16px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      flex:1;
      min-width:120px;
      white-space:nowrap;
      transition:all 0.2s;
      color:var(--text-color);
    }
    button:hover{
      filter:brightness(1.2);
    }
    button.primary{
      background:var(--primary);
      color:white;
      border:none;
    }
    button.primary:hover{
      filter: brightness(1.1);
    }
    button.success{
      background:var(--success);
      color:white;
      border:none;
    }
    button.danger{
      background:var(--danger);
      color:white;
      border:none;
    }
    input,select,textarea{
      padding:10px 12px;
      border:1px solid var(--border-color);
      border-radius:8px;
      width:100%;
      font-size:14px;
      background:var(--card);
      color:var(--text-color);
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 340px;
      gap:16px;
    }
    .card{
      background:var(--card);
      padding:16px;
      border-radius:10px;
      box-shadow:0 1px 3px rgba(0,0,0,0.2);
      border:1px solid var(--border-color);
    }
    .list{
      max-height:65vh;
      overflow:auto;
    }
    .item{
      display:flex;
      justify-content:space-between;
      gap:16px;
      padding:16px;
      border-bottom:1px solid var(--border-color);
      align-items:center;
    }
    .meta{
      font-size:14px;
      color:var(--muted);
    }
    .small{
      font-size:14px;
      color:var(--muted);
    }
    .badge{
      background:#eef2ff;
      color:#1e3a8a;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      display:inline-block;
    }
    .right{
      display:flex;
      gap:8px;
    }
    .actions button{
      padding:8px 10px;
      font-size:13px;
      min-width:auto;
    }
    .report-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      margin-top:16px;
    }
    .report{
      background:rgba(255,255,255,0.05);
      padding:12px;
      border-radius:8px;
      text-align:center;
    }
    /* modal */
    .modal-bg{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:24px;
      z-index:60;
    }
    .modal{
      width:100%;
      max-width:760px;
      background:var(--card);
      padding:20px;
      border-radius:10px;
      box-shadow:0 8px 30px rgba(2,6,23,0.2);
      max-height:90vh;
      overflow-y:auto;
      border:1px solid var(--border-color);
    }
    .modal h3{
      color:var(--primary);
      padding-bottom:8px;
      border-bottom:1px solid var(--border-color);
    }
    .form-section{
      margin-bottom:16px;
      padding:12px;
      background:rgba(255,255,255,0.05);
      border-radius:8px;
    }
    .form-section h4{
      margin-top:0;
      margin-bottom:12px;
      color:var(--primary);
    }
    label{
      display:block;
      margin-bottom:8px;
      font-size:14px;
    }
    .form-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    .file-input{
      display:none;
    }
    /* appointments */
    .appointments-list{
      margin-top:12px;
    }
    .appointment-item{
      display:flex;
      justify-content:space-between;
      padding:8px;
      background:rgba(255,255,255,0.05);
      border-radius:6px;
      margin-bottom:8px;
      border:1px solid var(--border-color);
      align-items:center;
    }
    .appointment-actions{
      display:flex;
      gap:6px;
    }
    /* modal actions */
    .modal-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }
    .modal-actions .left-actions {
      display: flex;
      gap: 8px;
    }
    .modal-actions .right-actions {
      display: flex;
      gap: 8px;
    }
    .modal-actions button {
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      min-width: 100px;
      text-align: center;
    }
    .modal-actions button.primary {
      background-color: var(--primary);
      color: white;
      border: none;
    }
    .modal-actions button.primary:hover {
      filter: brightness(1.1);
    }
    .modal-actions button.secondary {
      background-color: var(--card);
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    .modal-actions button.secondary:hover {
      background-color: rgba(11, 99, 214, 0.1);
    }
    .modal-actions button.danger {
      background-color: var(--card);
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    .modal-actions button.danger:hover {
      background-color: rgba(239, 68, 68, 0.1);
    }
    .modal-actions button.neutral {
      background-color: rgba(255,255,255,0.1);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    .modal-actions button.neutral:hover {
      background-color: rgba(255,255,255,0.2);
    }
    .small-button {
      padding: 6px 10px !important;
      font-size: 13px !important;
      min-width: auto !important;
    }
    
    /* Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© */
    .settings-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      gap: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .settings-menu {
      position: absolute;
      left: 0;
      top: 50px;
      background: var(--card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      width: 320px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 100;
      display: none;
    }
    
    .settings-menu.show {
      display: block;
    }
    
    .settings-section {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .settings-section h4 {
      margin-top: 0;
      margin-bottom: 12px;
      color: var(--primary);
    }
    
    .theme-options {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .theme-option {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .theme-option.selected {
      border-color: var(--text-color);
      transform: scale(1.05);
    }
    
    .theme-option.blue { background: #1a1a2e; }
    .theme-option.dark { background: #121212; }
    .theme-option.light { background: #f5f7fb; color: #333; }
    .theme-option.green { background: #1a2e1a; }
    .theme-option.purple { background: #2d1a3d; }
    .theme-option.gold { background: #3d2c1a; }
    .theme-option.ocean { background: #1a2e3d; }
    
    .font-size-options {
      display: flex;
      gap: 8px;
    }
    
    .font-size-btn {
      padding: 6px 10px;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
      cursor: pointer;
    }
    
    .font-size-btn.selected {
      background: var(--primary);
      color: white;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--primary);
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    /* Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø·Ø¨Ø¹ ÙˆØ§Ù„Ù†Ø´Ø± */
    .copyright {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      color: var(--muted);
      font-size: 14px;
      border-top: 1px solid var(--border-color);
    }
    
    /* Ø²Ø± Ø§Ù„Ù…Ø·ÙˆØ± */
    .developer-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 0 10px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .developer-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* responsive adjustments */
    @media(max-width:980px){
      .grid{
        grid-template-columns:1fr;
      }
      .right{
        gap:6px;
      }
    }
    @media(max-width:768px){
      header{
        flex-direction:column;
        align-items:stretch;
        gap:12px;
      }
      .controls{
        width:100%;
      }
      .controls > *{
        flex:1 1 150px;
      }
      .form-row{
        grid-template-columns:1fr;
      }
      .report-grid{
        grid-template-columns:repeat(2,1fr);
      }
      .item{
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
      }
      .right{
        width:100%;
        justify-content:flex-end;
      }
      .modal-actions {
        flex-direction: column-reverse;
        gap: 8px;
      }
      .modal-actions .left-actions,
      .modal-actions .right-actions {
        width: 100%;
      }
      .modal-actions button {
        width: 100%;
      }
      .developer-btn {
        margin-top: 10px;
        width: 100%;
        justify-content: center;
      }
    }
    @media(max-width:480px){
      .report-grid{
        grid-template-columns:1fr;
      }
      .controls > *{
        flex:1 1 100%;
      }
      .actions{
        flex-wrap:wrap;
      }
      .actions button{
        flex:1 1 45%;
      }
      .settings-menu {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±Ø§Ø¬Ø¹ÙŠ Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ù†Ø§Ù†</h1>
      <button class="settings-btn" id="settingsBtn">âš™ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      <div class="settings-menu" id="settingsMenu">
        <div class="settings-section">
          <h4>ğŸ¨ Ø§Ù„Ù…Ø¸Ù‡Ø±</h4>
          <div>Ø§Ø®ØªØ± Ù„ÙˆÙ† Ø§Ù„Ø³Ù…Ø©:</div>
          <div class="theme-options">
            <div class="theme-option blue selected" data-theme="blue">Ø£</div>
            <div class="theme-option dark" data-theme="dark">Ø¨</div>
            <div class="theme-option light" data-theme="light">Ø¬</div>
            <div class="theme-option green" data-theme="green">Ø¯</div>
            <div class="theme-option purple" data-theme="purple">Ù‡Ù€</div>
            <div class="theme-option gold" data-theme="gold">Ùˆ</div>
            <div class="theme-option ocean" data-theme="ocean">Ø²</div>
          </div>
          
          <div>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</div>
          <div class="font-size-options">
            <div class="font-size-btn selected" data-size="14">ØµØºÙŠØ±</div>
            <div class="font-size-btn" data-size="16">Ù…ØªÙˆØ³Ø·</div>
            <div class="font-size-btn" data-size="18">ÙƒØ¨ÙŠØ±</div>
          </div>
        </div>
        
        <div class="settings-section">
          <h4>âš™ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h4>
          <div class="toggle-label">
            <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
            <label class="toggle-switch">
              <input type="checkbox" id="nightModeToggle">
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="toggle-label">
            <span>Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</span>
            <label class="toggle-switch">
              <input type="checkbox" id="notificationsToggle" checked>
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="toggle-label">
            <span>Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…</span>
            <label class="toggle-switch">
              <input type="checkbox" id="advancedSearchToggle">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <div class="settings-section">
          <button class="primary" style="width:100%" id="saveSettingsBtn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
      </div>
      
      <div class="controls">
        <button class="primary" id="newBtn">â• Ù…Ø±Ø§Ø¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
        <button id="backupBtn">ğŸ’¾ Ø­ÙØ¸ JSON</button>
        <button id="csvBtn">ğŸ“¤ ØªØµØ¯ÙŠØ± CSV</button>
        <label style="background:var(--card);border:1px solid var(--border-color);padding:10px 16px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex:1;min-width:120px;">
          ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
          <input type="file" id="importFile" class="file-input" accept="application/json">
        </label>
      </div>
    </header>

    <section class="card" style="margin-bottom:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª" style="flex:1;min-width:200px;">
      <select id="statusFilter" style="min-width:120px;">
        <option value="All">Ø§Ù„ÙƒÙ„</option>
        <option value="New">Ø¬Ø¯ÙŠØ¯</option>
        <option value="Returning">Ø±Ø§Ø¬Ø¹</option>
        <option value="In-treatment">ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬</option>
      </select>
      <select id="sortBy" style="min-width:160px;">
        <option value="name">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø§Ø³Ù…</option>
        <option value="lastVisit">ØªØ±ØªÙŠØ¨ Ø¨Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</option>
        <option value="fees">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ù…Ø¨Ø§Ù„Øº</option>
      </select>
    </section>

    <div class="grid">
      <main class="card">
        <h3 style="margin-top:0">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ† <span id="count" class="small"></span></h3>
        <div class="list" id="list"></div>
        <div id="emptyMsg" class="small" style="display:none;margin-top:12px">âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</div>

        <div class="report-grid">
          <div class="report"><div class="small">ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ†</div><div id="totalPatients" style="font-weight:700"></div></div>
          <div class="report"><div class="small">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº (IQD)</div><div id="totalFees" style="font-weight:700"></div></div>
          <div class="report"><div class="small">ğŸ“… Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div><div id="todayCount" style="font-weight:700"></div></div>
        </div>
      </main>

      <aside>
        <div class="card" style="margin-bottom:12px">
          <h4 style="margin:0 0 12px 0">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h4>
          <div style="display:flex;flex-direction:column;gap:12px">
            <button id="downloadBackup">ğŸ’¾ ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
            <button id="resetDemo" class="danger">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 12px 0">â“ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h4>
          <ol style="padding-left:18px;margin:0" class="small">
            <li>Ø§Ù†Ù‚Ø± "Ù…Ø±Ø§Ø¬Ø¹ Ø¬Ø¯ÙŠØ¯" Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ø¬Ø¹.</li>
            <li>Ø§Ø³ØªØ®Ø¯Ù… Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ø¹Ø«ÙˆØ± Ø¨Ø³Ø±Ø¹Ø©.</li>
            <li>Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± JSON ÙˆCSV Ù„Ø£Ø®Ø° Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</li>
          </ol>
        </div>
      </aside>
    </div>

    <!-- Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø·Ø¨Ø¹ ÙˆØ§Ù„Ù†Ø´Ø± -->
    <div class="copyright">
      Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; Ø²ÙŠØ¯ Ø¹Ù„ÙŠ Ø§Ù„Ø¹Ù„ÙŠ 2026
      <button id="developerBtn" class="developer-btn">ğŸ‘¨â€ğŸ’» Ø²ÙŠØ§Ø±Ø© ØµÙØ­Ø© Ø§Ù„Ù…Ø·ÙˆØ±</button>
    </div>

    <!-- modal root -->
    <div id="modalRoot" style="display:none"></div>
  </div>

  <script>
    /*****************************************************************
     * Dental Patients Manager (HTML/CSS/JS)
     * - Ù…ÙŠØ²Ø§Øª CRUD: Ø¥Ù†Ø´Ø§Ø¡ØŒ Ù‚Ø±Ø§Ø¡Ø©ØŒ ØªØ­Ø¯ÙŠØ«ØŒ Ø­Ø°Ù
     * - Ø¨Ø­Ø«ØŒ ØªØµÙÙŠØ©ØŒ ØªØ±ØªÙŠØ¨
     * - Ø¬Ø¯ÙˆÙ„Ø© Ù…ÙˆØ§Ø¹ÙŠØ¯ØŒ Ø¯ÙØ¹Ø§Øª Ø±Ø³ÙˆÙ…ØŒ Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø© Ù…Ø±Ø§Ø¬Ø¹
     * - Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± JSON ÙˆCSVØŒ Ø­ÙØ¸ ÙÙŠ localStorage
     *****************************************************************/

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const SAMPLE = [
      
      { 
        id: 'p2', 
        name: 'Ø²ÙŠØ¯ Ø¹Ù„ÙŠ ', 
        phone: '07748076476', 
        dob: '2002-5-20', 
        status: 'Returning', 
        lastVisit: '2025-8-1', 
        notes: '', 
        fees: 50000, 
        appointments: [
          {
            id:'a1', 
            datetime:'2025-08-15T10:00', 
            reason:'ØªÙ†Ø¸ÙŠÙ'
          }
        ] 
      }
    ];
    const STORAGE_KEY = 'dental_patients_v1';
    const SETTINGS_KEY = 'dental_settings_v1';
    let patients = [];
    
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let appSettings = {
      theme: 'blue',
      fontSize: '16',
      nightMode: false,
      notifications: true,
      advancedSearch: false
    };

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const listEl = document.getElementById('list');
    const countEl = document.getElementById('count');
    const totalPatientsEl = document.getElementById('totalPatients');
    const totalFeesEl = document.getElementById('totalFees');
    const todayCountEl = document.getElementById('todayCount');
    const emptyMsg = document.getElementById('emptyMsg');

    const searchInput = document.getElementById('search');
    const statusFilter = document.getElementById('statusFilter');
    const sortBy = document.getElementById('sortBy');
    
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsMenu = document.getElementById('settingsMenu');
    const nightModeToggle = document.getElementById('nightModeToggle');
    const notificationsToggle = document.getElementById('notificationsToggle');
    const advancedSearchToggle = document.getElementById('advancedSearchToggle');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        try { patients = JSON.parse(raw); }
        catch(e){ patients = SAMPLE.slice(); }
      } else { patients = SAMPLE.slice(); }
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      const settingsRaw = localStorage.getItem(SETTINGS_KEY);
      if (settingsRaw) {
        try { 
          appSettings = JSON.parse(settingsRaw); 
          applySettings();
        } catch(e){ /* ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ */ }
      }
    }
    
    function save(){ 
      localStorage.setItem(STORAGE_KEY, JSON.stringify(patients)); 
    }
    
    function saveSettings() {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
      applySettings();
    }
    
    function applySettings() {
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³Ù…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
      document.body.className = theme-${appSettings.theme};
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ø®Ø·
      document.documentElement.style.setProperty('--font-size', ${appSettings.fontSize}px);
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹
      if (appSettings.nightMode) {
        document.body.classList.add('night-mode');
      } else {
        document.body.classList.remove('night-mode');
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      if (nightModeToggle) nightModeToggle.checked = appSettings.nightMode;
      if (notificationsToggle) notificationsToggle.checked = appSettings.notifications;
      if (advancedSearchToggle) advancedSearchToggle.checked = appSettings.advancedSearch;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù…Ø©
      document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.theme === appSettings.theme) {
          opt.classList.add('selected');
        }
      });
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¬Ù… Ø§Ù„Ø®Ø·
      document.querySelectorAll('.font-size-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.dataset.size === appSettings.fontSize) {
          btn.classList.add('selected');
        }
      });
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
    function uid(prefix='p_'){ return prefix + Math.random().toString(36).slice(2,9); }

    // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø­Ù‚Ù† HTML
    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ†
    function render(){
      const q = (searchInput.value||'').trim().toLowerCase();
      let visible = patients.filter(p=>{
        if (statusFilter.value !== 'All' && p.status !== statusFilter.value) return false;
        if (!q) return true;
        return (p.name||'').toLowerCase().includes(q) || 
               (p.phone||'').toLowerCase().includes(q) || 
               (p.notes||'').toLowerCase().includes(q);
      });

      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      visible.sort((a,b)=>{
        if (sortBy.value === 'name') return a.name.localeCompare(b.name,'ar');
        if (sortBy.value === 'lastVisit') return (b.lastVisit||'').localeCompare(a.lastVisit||'');
        if (sortBy.value === 'fees') return (b.fees||0)-(a.fees||0);
        return 0;
      });

      listEl.innerHTML = '';
      visible.forEach(p=>{
        const item = document.createElement('div'); item.className='item';
        item.innerHTML = `
          <div style="flex:1">
            <div style="font-weight:700">${esc(p.name)}</div>
            <div class="meta">${esc(p.phone)} Â· ${p.dob||'-'} Â· <span class="badge">${p.status}</span></div>
            <div class="small" style="margin-top:8px">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${esc(p.notes||'-')}</div>
            <div class="small" style="margin-top:8px">ğŸ’° Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <strong>${p.fees||0}</strong> IQD</div>
          </div>
        `;
        const right = document.createElement('div'); right.className='right actions';
        const editBtn = document.createElement('button'); editBtn.textContent='âœ ØªØ¹Ø¯ÙŠÙ„';
        editBtn.onclick = ()=> openForm(p);
        const printBtn = document.createElement('button'); printBtn.textContent='ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©';
        printBtn.onclick = ()=> printCard(p);
        const payBtn = document.createElement('button'); payBtn.textContent='ğŸ’µ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©';
        payBtn.onclick = ()=>{
          const val = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹ (IQD) - Ø§Ø·Ø±Ø­ Ù„ØªÙ‚Ù„ÙŠÙ„:', '0');
          const n = parseInt(val,10);
          if (!isNaN(n)){ updateFees(p.id, n); }
        };
        const delBtn = document.createElement('button'); delBtn.textContent='ğŸ—‘ Ø­Ø°Ù';
        delBtn.className = 'danger small-button';
        delBtn.onclick = ()=>{
          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ØŸ')){ 
            patients = patients.filter(x=>x.id!==p.id); 
            save(); 
            render(); 
          }
        };
        right.append(editBtn, printBtn, payBtn, delBtn);
        item.appendChild(right);
        listEl.appendChild(item);
      });

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      countEl.textContent = (${visible.length});
      totalPatientsEl.textContent = patients.length;
      totalFeesEl.textContent = patients.reduce((s,p)=>s+(p.fees||0),0);
      const today = new Date().toISOString().slice(0,10);
      todayCountEl.textContent = patients.filter(p=>p.lastVisit && p.lastVisit.startsWith(today)).length;
      emptyMsg.style.display = visible.length ? 'none' : 'block';
    }

    // ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±Ø§Ø¬Ø¹
    function openForm(initial=null){
      const modalRoot = document.getElementById('modalRoot');
      modalRoot.style.display = 'block';
      modalRoot.innerHTML = `
        <div class="modal-bg">
          <div class="modal" role="dialog" aria-modal="true">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <h3>${initial ? 'âœ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹' : 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ø¬Ø¹ Ø¬Ø¯ÙŠØ¯'}</h3>
              <button id="closeModal" style="background:transparent;border:none;font-size:20px;cursor:pointer">âœ–</button>
            </div>
            <form id="pform">
              <div class="form-section">
                <h4>ğŸ“‹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                <div class="form-row">
                  <div>
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input id="f_name" required style="width:100%">
                  </div>
                  <div>
                    <label>ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input id="f_phone" type="tel" style="width:100%">
                  </div>
                </div>
                <div class="form-row">
                  <div>
                    <label>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
                    <input id="f_dob" type="date" style="width:100%">
                  </div>
                  <div>
                    <label>ğŸ· Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</label>
                    <select id="f_status" style="width:100%">
                      <option value="New">Ø¬Ø¯ÙŠØ¯</option>
                      <option value="Returning">Ø±Ø§Ø¬Ø¹</option>
                      <option value="In-treatment">ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="form-section">
                <h4>ğŸ’° Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
                <div class="form-row">
                  <div>
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (IQD)</label>
                    <input id="f_fees" type="number" value="0" style="width:100%">
                  </div>
                  <div>
                    <label>ğŸ“… ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</label>
                    <input id="f_last" type="date" style="width:100%">
                  </div>
                </div>
              </div>
              
              <div class="form-section">
                <h4>ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h4>
                <div>
                  <label>Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                  <textarea id="f_notes" rows="4" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-color)"></textarea>
                </div>
              </div>
              
              ${initial ? `
              <div class="form-section">
                <h4>ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</h4>
                <div class="appointments-list" id="appointmentsList">
                  ${initial.appointments && initial.appointments.length > 0 ? 
                    initial.appointments.map(a => `
                      <div class="appointment-item">
                        <div>
                          <strong>â° ${formatAppointmentDate(a.datetime)}</strong>
                          <div class="small">ğŸ“Œ ${a.reason || 'Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨ Ù…Ø­Ø¯Ø¯'}</div>
                        </div>
                        <div class="appointment-actions">
                          <button type="button" class="small-button secondary edit-appt" data-id="${a.id}">âœ ØªØ¹Ø¯ÙŠÙ„</button>
                          <button type="button" class="small-button danger delete-appt" data-id="${a.id}">ğŸ—‘ Ø­Ø°Ù</button>
                        </div>
                      </div>
                    `).join('') : 
                    '<div class="small">âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø³Ø¬Ù„Ø©</div>'
                  }
                </div>
              </div>
              ` : ''}
              
              <div class="modal-actions">
                <div class="left-actions">
                  <button type="button" id="cancelBtn" class="neutral">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                </div>
                <div class="right-actions">
                  <button type="button" id="addAppt" class="secondary">â• Ø¬Ø¯ÙˆÙ„Ø© Ù…ÙˆØ¹Ø¯</button>
                  <button type="submit" class="primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      `;
      
      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ¹Ø¯ÙŠÙ„Ø§Ù‹
      if (initial){
        document.getElementById('f_name').value = initial.name||'';
        document.getElementById('f_phone').value = initial.phone||'';
        document.getElementById('f_dob').value = initial.dob||'';
        document.getElementById('f_status').value = initial.status||'New';
        document.getElementById('f_notes').value = initial.notes||'';
        document.getElementById('f_fees').value = initial.fees||0;
        document.getElementById('f_last').value = initial.lastVisit||'';
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
        if (initial.appointments && initial.appointments.length > 0) {
          document.querySelectorAll('.edit-appt').forEach(btn => {
            btn.onclick = function() {
              const apptId = this.getAttribute('data-id');
              const appt = initial.appointments.find(a => a.id === apptId);
              if (appt) {
                const newDt = prompt('ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù…ÙˆØ¹Ø¯:', appt.datetime);
                if (newDt) {
                  const newReason = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯:', appt.reason) || '';
                  appt.datetime = newDt;
                  appt.reason = newReason;
                  save();
                  render();
                  openForm(initial); // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªØ­Ø¯ÙŠØ«
                }
              }
            };
          });
          
          document.querySelectorAll('.delete-appt').forEach(btn => {
            btn.onclick = function() {
              const apptId = this.getAttribute('data-id');
              if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ØŸ')) {
                initial.appointments = initial.appointments.filter(a => a.id !== apptId);
                save();
                render();
                openForm(initial); // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªØ­Ø¯ÙŠØ«
              }
            };
          });
        }
      }

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
      document.getElementById('closeModal').onclick = ()=>{ 
        modalRoot.style.display='none'; 
        modalRoot.innerHTML=''; 
        window._unsavedAppts=[]; 
      };
      
      document.getElementById('cancelBtn').onclick = ()=>{ 
        modalRoot.style.display='none'; 
        modalRoot.innerHTML=''; 
        window._unsavedAppts=[]; 
      };

      // Ø²Ø± Ø¬Ø¯ÙˆÙ„Ø© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯
      document.getElementById('addAppt').onclick = ()=>{
        const dt = prompt('Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù…ÙˆØ¹Ø¯ (Ù…Ø«Ø§Ù„: 2025-08-15T10:00)');
        if (!dt) return;
        const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)') || '';
        if (initial && initial.id){
          initial.appointments = initial.appointments||[];
          initial.appointments.push({ id: uid('a_'), datetime: dt, reason });
          patients = patients.map(p => p.id === initial.id ? initial : p);
          save(); 
          render(); 
          openForm(initial); // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        } else {
          window._unsavedAppts = window._unsavedAppts || [];
          window._unsavedAppts.push({ id: uid('a'), datetime: dt, reason });
          alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù…Ø¤Ù‚ØªØ§Ù‹ ÙˆØ³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹');
        }
      };

      // submit handler
      document.getElementById('pform').onsubmit = function(e){
        e.preventDefault();
        const payload = {
          id: initial ? initial.id : uid('p_'),
          name: document.getElementById('f_name').value.trim(),
          phone: document.getElementById('f_phone').value.trim(),
          dob: document.getElementById('f_dob').value || null,
          status: document.getElementById('f_status').value,
          notes: document.getElementById('f_notes').value.trim(),
          fees: Number(document.getElementById('f_fees').value || 0),
          lastVisit: document.getElementById('f_last').value || null,
          appointments: (initial && initial.appointments) ? initial.appointments.slice() : []
        };
        if (window._unsavedAppts && window._unsavedAppts.length){
          payload.appointments = payload.appointments.concat(window._unsavedAppts);
          window._unsavedAppts = [];
        }
        if (initial){
          patients = patients.map(p => p.id === initial.id ? payload : p);
        } else {
          patients.unshift(payload);
        }
        save(); 
        render(); 
        modalRoot.style.display='none'; 
        modalRoot.innerHTML='';
      };
    }

    // Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹
    function printCard(p){
      const w = window.open('','_blank','width=600,height=700');
      if (!w) return alert('ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ø­Ø¬ÙˆØ¨');
      const html = `
        <html dir="rtl"><head><meta charset="utf-8"><title>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</title>
        <style>
          body{font-family:Arial;padding:24px} 
          .card{
            border:1px solid #333;
            padding:24px;
            border-radius:8px;
            max-width:500px;
            margin:0 auto
          }
          h2{
            text-align:center;
            margin-top:0;
            color:#0b63d6;
          }
          p{
            margin:12px 0;
            line-height:1.6;
          }
          strong{
            color:#333;
          }
        </style>
        </head><body><div class="card">
        <h2>Ø¹ÙŠØ§Ø¯Ø© Ø£Ø³Ù†Ø§Ù† â€” Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</h2>
        <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${esc(p.name)}</p>
        <p><strong>Ù‡Ø§ØªÙ:</strong> ${esc(p.phone)}</p>
        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</strong> ${p.dob||'-'}</p>
        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${p.status||'-'}</p>
        <p><strong>Ø§Ø®Ø± Ø²ÙŠØ§Ø±Ø©:</strong> ${p.lastVisit||'-'}</p>
        <p><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${esc(p.notes||'-')}</p>
        <p><strong>Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</strong> ${p.fees||0} IQD</p>
        <p style="text-align:center;margin-top:20px;color:#666;font-size:12px">
          Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; Ø²ÙŠØ¯ Ø¹Ù„ÙŠ Ø§Ù„Ø¹Ù„ÙŠ 2026
        </p>
        </div></body></html>`;
      w.document.write(html); 
      w.document.close(); 
      w.print();
    }

    // ØªÙ†Ø³ÙŠÙ‚ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯
    function formatAppointmentDate(datetime){
      try {
        const dt = new Date(datetime);
        return dt.toLocaleString('ar-EG', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch(e) {
        return datetime;
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©
    function updateFees(id, amount){
      patients = patients.map(p => p.id === id ? {...p, fees: (p.fees||0) + Number(amount)} : p);
      save(); 
      render();
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function exportJSON(){
      const blob = new Blob([JSON.stringify(patients,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'dental_patients.json'; 
      a.click(); 
      URL.revokeObjectURL(url);
    }
    
    function exportCSV(){
      const header = ['id','name','phone','dob','status','lastVisit','fees','notes'].join(',');
      const rows = patients.map(p => [p.id, quote(p.name), quote(p.phone), p.dob||'', p.status||'', p.lastVisit||'', p.fees||0, quote(p.notes||'')].join(','));
      const csv = [header, ...rows].join('\n');
      const blob = new Blob([csv],{type:'text/csv'}); 
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'dental_patients.csv'; 
      a.click(); 
      URL.revokeObjectURL(url);
    }
    
    function quote(s){ return '"' + String(s||'').replace(/"/g,'""') + '"'; }

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    document.getElementById('newBtn').onclick = ()=> openForm();
    document.getElementById('backupBtn').onclick = ()=> exportJSON();
    document.getElementById('csvBtn').onclick = ()=> exportCSV();
    document.getElementById('downloadBackup').onclick = ()=> exportJSON();
    document.getElementById('resetDemo').onclick = ()=>{ 
      if (confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø«Ø§Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')){ 
        patients = SAMPLE.slice(); 
        save(); 
        render(); 
      } 
    };

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById('importFile').onchange = function(e){
      const f = e.target.files[0]; 
      if (!f) return;
      const r = new FileReader();
      r.onload = function(){ 
        try {
          const data = JSON.parse(r.result);
          if (!Array.isArray(data)) throw new Error('Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­');
          patients = data; 
          save(); 
          render(); 
          alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        } catch(err){ 
          alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + err.message); 
        } 
      };
      r.readAsText(f);
      // reset input
      e.target.value = '';
    };

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨
    [searchInput, statusFilter, sortBy].forEach(el => el.addEventListener('input', render));
    
    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    settingsBtn.onclick = function() {
      settingsMenu.classList.toggle('show');
    };
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', function(e) {
      if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
        settingsMenu.classList.remove('show');
      }
    });
    
    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù…Ø©
    document.querySelectorAll('.theme-option').forEach(opt => {
      opt.onclick = function() {
        appSettings.theme = this.dataset.theme;
        document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
      };
    });
    
    // Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¬Ù… Ø§Ù„Ø®Ø·
    document.querySelectorAll('.font-size-btn').forEach(btn => {
      btn.onclick = function() {
        appSettings.fontSize = this.dataset.size;
        document.querySelectorAll('.font-size-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
      };
    });
    
    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    saveSettingsBtn.onclick = function() {
      appSettings.nightMode = nightModeToggle.checked;
      appSettings.notifications = notificationsToggle.checked;
      appSettings.advancedSearch = advancedSearchToggle.checked;
      saveSettings();
      settingsMenu.classList.remove('show');
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    };

    // Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ø·ÙˆØ±
    document.getElementById('developerBtn').onclick = function() {
      window.open('https://ornmo502.wordpress.com/', '_blank');
    };

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    load(); 
    render();

    // ØªØ¹Ø±ÙŠØ¶ Ø¨Ø¹Ø¶ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„ØªØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    window._dp = { patients, save, render, openForm, appSettings, saveSettings };

  </script>
</body>
</html>      --primary:#ff9800; --accent:#ff5722;
    }
    .theme-ocean {
      --bg:#1a2e3d; --card:#162e4e; --border-color:#2a5a6a;
      --primary:#2196f3; --accent:#00bcd4;
    }
    
    *{box-sizing:border-box}
    body{
      font-family:system-ui,Segoe UI,Arial;
      line-height:1.5;
      background:var(--bg);
      margin:0;
      padding:16px;
      color:var(--text-color);
      min-height:100vh;
      font-size:var(--font-size);
      transition: all 0.3s ease;
    }
    .container{
      max-width:1200px;
      margin:0 auto;
      width:100%;
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
      flex-wrap:wrap;
      position:relative;
    }
    h1{
      font-size:22px;
      margin:0;
      min-width:200px;
    }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      flex:1;
      min-width:300px;
    }
    button{
      background:var(--card);
      border:1px solid var(--border-color);
      padding:10px 16px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      flex:1;
      min-width:120px;
      white-space:nowrap;
      transition:all 0.2s;
      color:var(--text-color);
    }
    button:hover{
      filter:brightness(1.2);
    }
    button.primary{
      background:var(--primary);
      color:white;
      border:none;
    }
    button.primary:hover{
      filter: brightness(1.1);
    }
    button.success{
      background:var(--success);
      color:white;
      border:none;
    }
    button.danger{
      background:var(--danger);
      color:white;
      border:none;
    }
    input,select,textarea{
      padding:10px 12px;
      border:1px solid var(--border-color);
      border-radius:8px;
      width:100%;
      font-size:14px;
      background:var(--card);
      color:var(--text-color);
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 340px;
      gap:16px;
    }
    .card{
      background:var(--card);
      padding:16px;
      border-radius:10px;
      box-shadow:0 1px 3px rgba(0,0,0,0.2);
      border:1px solid var(--border-color);
    }
    .list{
      max-height:65vh;
      overflow:auto;
    }
    .item{
      display:flex;
      justify-content:space-between;
      gap:16px;
      padding:16px;
      border-bottom:1px solid var(--border-color);
      align-items:center;
    }
    .meta{
      font-size:14px;
      color:var(--muted);
    }
    .small{
      font-size:14px;
      color:var(--muted);
    }
    .badge{
      background:#eef2ff;
      color:#1e3a8a;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      display:inline-block;
    }
    .right{
      display:flex;
      gap:8px;
    }
    .actions button{
      padding:8px 10px;
      font-size:13px;
      min-width:auto;
    }
    .report-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      margin-top:16px;
    }
    .report{
      background:rgba(255,255,255,0.05);
      padding:12px;
      border-radius:8px;
      text-align:center;
    }
    /* modal */
    .modal-bg{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:24px;
      z-index:60;
    }
    .modal{
      width:100%;
      max-width:760px;
      background:var(--card);
      padding:20px;
      border-radius:10px;
      box-shadow:0 8px 30px rgba(2,6,23,0.2);
      max-height:90vh;
      overflow-y:auto;
      border:1px solid var(--border-color);
    }
    .modal h3{
      color:var(--primary);
      padding-bottom:8px;
      border-bottom:1px solid var(--border-color);
    }
    .form-section{
      margin-bottom:16px;
      padding:12px;
      background:rgba(255,255,255,0.05);
      border-radius:8px;
    }
    .form-section h4{
      margin-top:0;
      margin-bottom:12px;
      color:var(--primary);
    }
    label{
      display:block;
      margin-bottom:8px;
      font-size:14px;
    }
    .form-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    .file-input{
      display:none;
    }
    /* appointments */
    .appointments-list{
      margin-top:12px;
    }
    .appointment-item{
      display:flex;
      justify-content:space-between;
      padding:8px;
      background:rgba(255,255,255,0.05);
      border-radius:6px;
      margin-bottom:8px;
      border:1px solid var(--border-color);
      align-items:center;
    }
    .appointment-actions{
      display:flex;
      gap:6px;
    }
    /* modal actions */
    .modal-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }
    .modal-actions .left-actions {
      display: flex;
      gap: 8px;
    }
    .modal-actions .right-actions {
      display: flex;
      gap: 8px;
    }
    .modal-actions button {
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      min-width: 100px;
      text-align: center;
    }
    .modal-actions button.primary {
      background-color: var(--primary);
      color: white;
      border: none;
    }
    .modal-actions button.primary:hover {
      filter: brightness(1.1);
    }
    .modal-actions button.secondary {
      background-color: var(--card);
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    .modal-actions button.secondary:hover {
      background-color: rgba(11, 99, 214, 0.1);
    }
    .modal-actions button.danger {
      background-color: var(--card);
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    .modal-actions button.danger:hover {
      background-color: rgba(239, 68, 68, 0.1);
    }
    .modal-actions button.neutral {
      background-color: rgba(255,255,255,0.1);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    .modal-actions button.neutral:hover {
      background-color: rgba(255,255,255,0.2);
    }
    .small-button {
      padding: 6px 10px !important;
      font-size: 13px !important;
      min-width: auto !important;
    }
    
    /* Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© */
    .settings-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      gap: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .settings-menu {
      position: absolute;
      left: 0;
      top: 50px;
      background: var(--card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      width: 320px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 100;
      display: none;
    }
    
    .settings-menu.show {
      display: block;
    }
    
    .settings-section {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .settings-section h4 {
      margin-top: 0;
      margin-bottom: 12px;
      color: var(--primary);
    }
    
    .theme-options {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .theme-option {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .theme-option.selected {
      border-color: var(--text-color);
      transform: scale(1.05);
    }
    
    .theme-option.blue { background: #1a1a2e; }
    .theme-option.dark { background: #121212; }
    .theme-option.light { background: #f5f7fb; color: #333; }
    .theme-option.green { background: #1a2e1a; }
    .theme-option.purple { background: #2d1a3d; }
    .theme-option.gold { background: #3d2c1a; }
    .theme-option.ocean { background: #1a2e3d; }
    
    .font-size-options {
      display: flex;
      gap: 8px;
    }
    
    .font-size-btn {
      padding: 6px 10px;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
      cursor: pointer;
    }
    
    .font-size-btn.selected {
      background: var(--primary);
      color: white;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--primary);
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    /* Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø·Ø¨Ø¹ ÙˆØ§Ù„Ù†Ø´Ø± */
    .copyright {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      color: var(--muted);
      font-size: 14px;
      border-top: 1px solid var(--border-color);
    }
    
    /* Ø²Ø± Ø§Ù„Ù…Ø·ÙˆØ± */
    .developer-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      margin: 0 10px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .developer-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* responsive adjustments */
    @media(max-width:980px){
      .grid{
        grid-template-columns:1fr;
      }
      .right{
        gap:6px;
      }
    }
    @media(max-width:768px){
      header{
        flex-direction:column;
        align-items:stretch;
        gap:12px;
      }
      .controls{
        width:100%;
      }
      .controls > *{
        flex:1 1 150px;
      }
      .form-row{
        grid-template-columns:1fr;
      }
      .report-grid{
        grid-template-columns:repeat(2,1fr);
      }
      .item{
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
      }
      .right{
        width:100%;
        justify-content:flex-end;
      }
      .modal-actions {
        flex-direction: column-reverse;
        gap: 8px;
      }
      .modal-actions .left-actions,
      .modal-actions .right-actions {
        width: 100%;
      }
      .modal-actions button {
        width: 100%;
      }
      .developer-btn {
        margin-top: 10px;
        width: 100%;
        justify-content: center;
      }
    }
    @media(max-width:480px){
      .report-grid{
        grid-template-columns:1fr;
      }
      .controls > *{
        flex:1 1 100%;
      }
      .actions{
        flex-wrap:wrap;
      }
      .actions button{
        flex:1 1 45%;
      }
      .settings-menu {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±Ø§Ø¬Ø¹ÙŠ Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ù†Ø§Ù†</h1>
      <button class="settings-btn" id="settingsBtn">âš™ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      <div class="settings-menu" id="settingsMenu">
        <div class="settings-section">
          <h4>ğŸ¨ Ø§Ù„Ù…Ø¸Ù‡Ø±</h4>
          <div>Ø§Ø®ØªØ± Ù„ÙˆÙ† Ø§Ù„Ø³Ù…Ø©:</div>
          <div class="theme-options">
            <div class="theme-option blue selected" data-theme="blue">Ø£</div>
            <div class="theme-option dark" data-theme="dark">Ø¨</div>
            <div class="theme-option light" data-theme="light">Ø¬</div>
            <div class="theme-option green" data-theme="green">Ø¯</div>
            <div class="theme-option purple" data-theme="purple">Ù‡Ù€</div>
            <div class="theme-option gold" data-theme="gold">Ùˆ</div>
            <div class="theme-option ocean" data-theme="ocean">Ø²</div>
          </div>
          
          <div>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</div>
          <div class="font-size-options">
            <div class="font-size-btn selected" data-size="14">ØµØºÙŠØ±</div>
            <div class="font-size-btn" data-size="16">Ù…ØªÙˆØ³Ø·</div>
            <div class="font-size-btn" data-size="18">ÙƒØ¨ÙŠØ±</div>
          </div>
        </div>
        
        <div class="settings-section">
          <h4>âš™ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h4>
          <div class="toggle-label">
            <span>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
            <label class="toggle-switch">
              <input type="checkbox" id="nightModeToggle">
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="toggle-label">
            <span>Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</span>
            <label class="toggle-switch">
              <input type="checkbox" id="notificationsToggle" checked>
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="toggle-label">
            <span>Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…</span>
            <label class="toggle-switch">
              <input type="checkbox" id="advancedSearchToggle">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <div class="settings-section">
          <button class="primary" style="width:100%" id="saveSettingsBtn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
      </div>
      
      <div class="controls">
        <button class="primary" id="newBtn">â• Ù…Ø±Ø§Ø¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
        <button id="backupBtn">ğŸ’¾ Ø­ÙØ¸ JSON</button>
        <button id="csvBtn">ğŸ“¤ ØªØµØ¯ÙŠØ± CSV</button>
        <label style="background:var(--card);border:1px solid var(--border-color);padding:10px 16px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex:1;min-width:120px;">
          ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
          <input type="file" id="importFile" class="file-input" accept="application/json">
        </label>
      </div>
    </header>

    <section class="card" style="margin-bottom:16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <input id="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª" style="flex:1;min-width:200px;">
      <select id="statusFilter" style="min-width:120px;">
        <option value="All">Ø§Ù„ÙƒÙ„</option>
        <option value="New">Ø¬Ø¯ÙŠØ¯</option>
        <option value="Returning">Ø±Ø§Ø¬Ø¹</option>
        <option value="In-treatment">ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬</option>
      </select>
      <select id="sortBy" style="min-width:160px;">
        <option value="name">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø§Ø³Ù…</option>
        <option value="lastVisit">ØªØ±ØªÙŠØ¨ Ø¨Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</option>
        <option value="fees">ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ù…Ø¨Ø§Ù„Øº</option>
      </select>
    </section>

    <div class="grid">
      <main class="card">
        <h3 style="margin-top:0">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ† <span id="count" class="small"></span></h3>
        <div class="list" id="list"></div>
        <div id="emptyMsg" class="small" style="display:none;margin-top:12px">âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</div>

        <div class="report-grid">
          <div class="report"><div class="small">ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ†</div><div id="totalPatients" style="font-weight:700"></div></div>
          <div class="report"><div class="small">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº (IQD)</div><div id="totalFees" style="font-weight:700"></div></div>
          <div class="report"><div class="small">ğŸ“… Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div><div id="todayCount" style="font-weight:700"></div></div>
        </div>
      </main>

      <aside>
        <div class="card" style="margin-bottom:12px">
          <h4 style="margin:0 0 12px 0">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h4>
          <div style="display:flex;flex-direction:column;gap:12px">
            <button id="downloadBackup">ğŸ’¾ ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
            <button id="resetDemo" class="danger">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
          </div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 12px 0">â“ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h4>
          <ol style="padding-left:18px;margin:0" class="small">
            <li>Ø§Ù†Ù‚Ø± "Ù…Ø±Ø§Ø¬Ø¹ Ø¬Ø¯ÙŠØ¯" Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ø¬Ø¹.</li>
            <li>Ø§Ø³ØªØ®Ø¯Ù… Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ù„Ø¹Ø«ÙˆØ± Ø¨Ø³Ø±Ø¹Ø©.</li>
            <li>Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± JSON ÙˆCSV Ù„Ø£Ø®Ø° Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</li>
          </ol>
        </div>
      </aside>
    </div>

    <!-- Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø·Ø¨Ø¹ ÙˆØ§Ù„Ù†Ø´Ø± -->
    <div class="copyright">
      Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; Ø²ÙŠØ¯ Ø¹Ù„ÙŠ Ø§Ù„Ø¹Ù„ÙŠ 2026
      <button id="developerBtn" class="developer-btn">ğŸ‘¨â€ğŸ’» Ø²ÙŠØ§Ø±Ø© ØµÙØ­Ø© Ø§Ù„Ù…Ø·ÙˆØ±</button>
    </div>

    <!-- modal root -->
    <div id="modalRoot" style="display:none"></div>
  </div>

  <script>
    /*****************************************************************
     * Dental Patients Manager (HTML/CSS/JS)
     * - Ù…ÙŠØ²Ø§Øª CRUD: Ø¥Ù†Ø´Ø§Ø¡ØŒ Ù‚Ø±Ø§Ø¡Ø©ØŒ ØªØ­Ø¯ÙŠØ«ØŒ Ø­Ø°Ù
     * - Ø¨Ø­Ø«ØŒ ØªØµÙÙŠØ©ØŒ ØªØ±ØªÙŠØ¨
     * - Ø¬Ø¯ÙˆÙ„Ø© Ù…ÙˆØ§Ø¹ÙŠØ¯ØŒ Ø¯ÙØ¹Ø§Øª Ø±Ø³ÙˆÙ…ØŒ Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø© Ù…Ø±Ø§Ø¬Ø¹
     * - Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± JSON ÙˆCSVØŒ Ø­ÙØ¸ ÙÙŠ localStorage
     *****************************************************************/

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const SAMPLE = [
      
      { 
        id: 'p2', 
        name: 'Ø²ÙŠØ¯ Ø¹Ù„ÙŠ ', 
        phone: '07748076476', 
        dob: '2002-5-20', 
        status: 'Returning', 
        lastVisit: '2025-8-1', 
        notes: '', 
        fees: 50000, 
        appointments: [
          {
            id:'a1', 
            datetime:'2025-08-15T10:00', 
            reason:'ØªÙ†Ø¸ÙŠÙ'
          }
        ] 
      }
    ];
    const STORAGE_KEY = 'dental_patients_v1';
    const SETTINGS_KEY = 'dental_settings_v1';
    let patients = [];
    
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let appSettings = {
      theme: 'blue',
      fontSize: '16',
      nightMode: false,
      notifications: true,
      advancedSearch: false
    };

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const listEl = document.getElementById('list');
    const countEl = document.getElementById('count');
    const totalPatientsEl = document.getElementById('totalPatients');
    const totalFeesEl = document.getElementById('totalFees');
    const todayCountEl = document.getElementById('todayCount');
    const emptyMsg = document.getElementById('emptyMsg');

    const searchInput = document.getElementById('search');
    const statusFilter = document.getElementById('statusFilter');
    const sortBy = document.getElementById('sortBy');
    
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsMenu = document.getElementById('settingsMenu');
    const nightModeToggle = document.getElementById('nightModeToggle');
    const notificationsToggle = document.getElementById('notificationsToggle');
    const advancedSearchToggle = document.getElementById('advancedSearchToggle');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        try { patients = JSON.parse(raw); }
        catch(e){ patients = SAMPLE.slice(); }
      } else { patients = SAMPLE.slice(); }
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      const settingsRaw = localStorage.getItem(SETTINGS_KEY);
      if (settingsRaw) {
        try { 
          appSettings = JSON.parse(settingsRaw); 
          applySettings();
        } catch(e){ /* ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ */ }
      }
    }
    
    function save(){ 
      localStorage.setItem(STORAGE_KEY, JSON.stringify(patients)); 
    }
    
    function saveSettings() {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
      applySettings();
    }
    
    function applySettings() {
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³Ù…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
      document.body.className = theme-${appSettings.theme};
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ø®Ø·
      document.documentElement.style.setProperty('--font-size', ${appSettings.fontSize}px);
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„Ø§Ù‹
      if (appSettings.nightMode) {
        document.body.classList.add('night-mode');
      } else {
        document.body.classList.remove('night-mode');
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      if (nightModeToggle) nightModeToggle.checked = appSettings.nightMode;
      if (notificationsToggle) notificationsToggle.checked = appSettings.notifications;
      if (advancedSearchToggle) advancedSearchToggle.checked = appSettings.advancedSearch;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù…Ø©
      document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.theme === appSettings.theme) {
          opt.classList.add('selected');
        }
      });
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¬Ù… Ø§Ù„Ø®Ø·
      document.querySelectorAll('.font-size-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.dataset.size === appSettings.fontSize) {
          btn.classList.add('selected');
        }
      });
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
    function uid(prefix='p_'){ return prefix + Math.random().toString(36).slice(2,9); }

    // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø­Ù‚Ù† HTML
    function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ†
    function render(){
      const q = (searchInput.value||'').trim().toLowerCase();
      let visible = patients.filter(p=>{
        if (statusFilter.value !== 'All' && p.status !== statusFilter.value) return false;
        if (!q) return true;
        return (p.name||'').toLowerCase().includes(q) || 
               (p.phone||'').toLowerCase().includes(q) || 
               (p.notes||'').toLowerCase().includes(q);
      });

      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      visible.sort((a,b)=>{
        if (sortBy.value === 'name') return a.name.localeCompare(b.name,'ar');
        if (sortBy.value === 'lastVisit') return (b.lastVisit||'').localeCompare(a.lastVisit||'');
        if (sortBy.value === 'fees') return (b.fees||0)-(a.fees||0);
        return 0;
      });

      listEl.innerHTML = '';
      visible.forEach(p=>{
        const item = document.createElement('div'); item.className='item';
        item.innerHTML = `
          <div style="flex:1">
            <div style="font-weight:700">${esc(p.name)}</div>
            <div class="meta">${esc(p.phone)} Â· ${p.dob||'-'} Â· <span class="badge">${p.status}</span></div>
            <div class="small" style="margin-top:8px">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${esc(p.notes||'-')}</div>
            <div class="small" style="margin-top:8px">ğŸ’° Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <strong>${p.fees||0}</strong> IQD</div>
          </div>
        `;
        const right = document.createElement('div'); right.className='right actions';
        const editBtn = document.createElement('button'); editBtn.textContent='âœ ØªØ¹Ø¯ÙŠÙ„';
        editBtn.onclick = ()=> openForm(p);
        const printBtn = document.createElement('button'); printBtn.textContent='ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©';
        printBtn.onclick = ()=> printCard(p);
        const payBtn = document.createElement('button'); payBtn.textContent='ğŸ’µ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©';
        payBtn.onclick = ()=>{
          const val = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹ (IQD) - Ø§Ø·Ø±Ø­ Ù„ØªÙ‚Ù„ÙŠÙ„:', '0');
          const n = parseInt(val,10);
          if (!isNaN(n)){ updateFees(p.id, n); }
        };
        const delBtn = document.createElement('button'); delBtn.textContent='ğŸ—‘ Ø­Ø°Ù';
        delBtn.className = 'danger small-button';
        delBtn.onclick = ()=>{
          if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ØŸ')){ 
            patients = patients.filter(x=>x.id!==p.id); 
            save(); 
            render(); 
          }
        };
        right.append(editBtn, printBtn, payBtn, delBtn);
        item.appendChild(right);
        listEl.appendChild(item);
      });

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      countEl.textContent = (${visible.length});
      totalPatientsEl.textContent = patients.length;
      totalFeesEl.textContent = patients.reduce((s,p)=>s+(p.fees||0),0);
      const today = new Date().toISOString().slice(0,10);
      todayCountEl.textContent = patients.filter(p=>p.lastVisit && p.lastVisit.startsWith(today)).length;
      emptyMsg.style.display = visible.length ? 'none' : 'block';
    }

    // ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±Ø§Ø¬Ø¹
    function openForm(initial=null){
      const modalRoot = document.getElementById('modalRoot');
      modalRoot.style.display = 'block';
      modalRoot.innerHTML = `
        <div class="modal-bg">
          <div class="modal" role="dialog" aria-modal="true">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <h3>${initial ? 'âœ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹' : 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ø¬Ø¹ Ø¬Ø¯ÙŠØ¯'}</h3>
              <button id="closeModal" style="background:transparent;border:none;font-size:20px;cursor:pointer">âœ–</button>
            </div>
            <form id="pform">
              <div class="form-section">
                <h4>ğŸ“‹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                <div class="form-row">
                  <div>
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input id="f_name" required style="width:100%">
                  </div>
                  <div>
                    <label>ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input id="f_phone" type="tel" style="width:100%">
                  </div>
                </div>
                <div class="form-row">
                  <div>
                    <label>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
                    <input id="f_dob" type="date" style="width:100%">
                  </div>
                  <div>
                    <label>ğŸ· Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</label>
                    <select id="f_status" style="width:100%">
                      <option value="New">Ø¬Ø¯ÙŠØ¯</option>
                      <option value="Returning">Ø±Ø§Ø¬Ø¹</option>
                      <option value="In-treatment">ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="form-section">
                <h4>ğŸ’° Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
                <div class="form-row">
                  <div>
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ (IQD)</label>
                    <input id="f_fees" type="number" value="0" style="width:100%">
                  </div>
                  <div>
                    <label>ğŸ“… ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</label>
                    <input id="f_last" type="date" style="width:100%">
                  </div>
                </div>
              </div>
              
              <div class="form-section">
                <h4>ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h4>
                <div>
                  <label>Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                  <textarea id="f_notes" rows="4" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-color)"></textarea>
                </div>
              </div>
              
              ${initial ? `
              <div class="form-section">
                <h4>ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</h4>
                <div class="appointments-list" id="appointmentsList">
                  ${initial.appointments && initial.appointments.length > 0 ? 
                    initial.appointments.map(a => `
                      <div class="appointment-item">
                        <div>
                          <strong>â° ${formatAppointmentDate(a.datetime)}</strong>
                          <div class="small">ğŸ“Œ ${a.reason || 'Ø¨Ø¯ÙˆÙ† Ø³Ø¨Ø¨ Ù…Ø­Ø¯Ø¯'}</div>
                        </div>
                        <div class="appointment-actions">
                          <button type="button" class="small-button secondary edit-appt" data-id="${a.id}">âœ ØªØ¹Ø¯ÙŠÙ„</button>
                          <button type="button" class="small-button danger delete-appt" data-id="${a.id}">ğŸ—‘ Ø­Ø°Ù</button>
                        </div>
                      </div>
                    `).join('') : 
                    '<div class="small">âš  Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø³Ø¬Ù„Ø©</div>'
                  }
                </div>
              </div>
              ` : ''}
              
              <div class="modal-actions">
                <div class="left-actions">
                  <button type="button" id="cancelBtn" class="neutral">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                </div>
                <div class="right-actions">
                  <button type="button" id="addAppt" class="secondary">â• Ø¬Ø¯ÙˆÙ„Ø© Ù…ÙˆØ¹Ø¯</button>
                  <button type="submit" class="primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      `;
      
      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ¹Ø¯ÙŠÙ„Ø§Ù‹
      if (initial){
        document.getElementById('f_name').value = initial.name||'';
        document.getElementById('f_phone').value = initial.phone||'';
        document.getElementById('f_dob').value = initial.dob||'';
        document.getElementById('f_status').value = initial.status||'New';
        document.getElementById('f_notes').value = initial.notes||'';
        document.getElementById('f_fees').value = initial.fees||0;
        document.getElementById('f_last').value = initial.lastVisit||'';
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
        if (initial.appointments && initial.appointments.length > 0) {
          document.querySelectorAll('.edit-appt').forEach(btn => {
            btn.onclick = function() {
              const apptId = this.getAttribute('data-id');
              const appt = initial.appointments.find(a => a.id === apptId);
              if (appt) {
                const newDt = prompt('ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù…ÙˆØ¹Ø¯:', appt.datetime);
                if (newDt) {
                  const newReason = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯:', appt.reason) || '';
                  appt.datetime = newDt;
                  appt.reason = newReason;
                  save();
                  render();
                  openForm(initial); // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªØ­Ø¯ÙŠØ«
                }
              }
            };
          });
          
          document.querySelectorAll('.delete-appt').forEach(btn => {
            btn.onclick = function() {
              const apptId = this.getAttribute('data-id');
              if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ØŸ')) {
                initial.appointments = initial.appointments.filter(a => a.id !== apptId);
                save();
                render();
                openForm(initial); // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªØ­Ø¯ÙŠØ«
              }
            };
          });
        }
      }

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
      document.getElementById('closeModal').onclick = ()=>{ 
        modalRoot.style.display='none'; 
        modalRoot.innerHTML=''; 
        window._unsavedAppts=[]; 
      };
      
      document.getElementById('cancelBtn').onclick = ()=>{ 
        modalRoot.style.display='none'; 
        modalRoot.innerHTML=''; 
        window._unsavedAppts=[]; 
      };

      // Ø²Ø± Ø¬Ø¯ÙˆÙ„Ø© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯
      document.getElementById('addAppt').onclick = ()=>{
        const dt = prompt('Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù…ÙˆØ¹Ø¯ (Ù…Ø«Ø§Ù„: 2025-08-15T10:00)');
        if (!dt) return;
        const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)') || '';
        if (initial && initial.id){
          initial.appointments = initial.appointments||[];
          initial.appointments.push({ id: uid('a_'), datetime: dt, reason });
          patients = patients.map(p => p.id === initial.id ? initial : p);
          save(); 
          render(); 
          openForm(initial); // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        } else {
          window._unsavedAppts = window._unsavedAppts || [];
          window._unsavedAppts.push({ id: uid('a'), datetime: dt, reason });
          alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù…Ø¤Ù‚ØªØ§Ù‹ ÙˆØ³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹');
        }
      };

      // submit handler
      document.getElementById('pform').onsubmit = function(e){
        e.preventDefault();
        const payload = {
          id: initial ? initial.id : uid('p_'),
          name: document.getElementById('f_name').value.trim(),
          phone: document.getElementById('f_phone').value.trim(),
          dob: document.getElementById('f_dob').value || null,
          status: document.getElementById('f_status').value,
          notes: document.getElementById('f_notes').value.trim(),
          fees: Number(document.getElementById('f_fees').value || 0),
          lastVisit: document.getElementById('f_last').value || null,
          appointments: (initial && initial.appointments) ? initial.appointments.slice() : []
        };
        if (window._unsavedAppts && window._unsavedAppts.length){
          payload.appointments = payload.appointments.concat(window._unsavedAppts);
          window._unsavedAppts = [];
        }
        if (initial){
          patients = patients.map(p => p.id === initial.id ? payload : p);
        } else {
          patients.unshift(payload);
        }
        save(); 
        render(); 
        modalRoot.style.display='none'; 
        modalRoot.innerHTML='';
      };
    }

    // Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹
    function printCard(p){
      const w = window.open('','_blank','width=600,height=700');
      if (!w) return alert('ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ø­Ø¬ÙˆØ¨');
      const html = `
        <html dir="rtl"><head><meta charset="utf-8"><title>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</title>
        <style>
          body{font-family:Arial;padding:24px} 
          .card{
            border:1px solid #333;
            padding:24px;
            border-radius:8px;
            max-width:500px;
            margin:0 auto
          }
          h2{
            text-align:center;
            margin-top:0;
            color:#0b63d6;
          }
          p{
            margin:12px 0;
            line-height:1.6;
          }
          strong{
            color:#333;
          }
        </style>
        </head><body><div class="card">
        <h2>Ø¹ÙŠØ§Ø¯Ø© Ø£Ø³Ù†Ø§Ù† â€” Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</h2>
        <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${esc(p.name)}</p>
        <p><strong>Ù‡Ø§ØªÙ:</strong> ${esc(p.phone)}</p>
        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</strong> ${p.dob||'-'}</p>
        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${p.status||'-'}</p>
        <p><strong>Ø§Ø®Ø± Ø²ÙŠØ§Ø±Ø©:</strong> ${p.lastVisit||'-'}</p>
        <p><strong>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${esc(p.notes||'-')}</p>
        <p><strong>Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©:</strong> ${p.fees||0} IQD</p>
        <p style="text-align:center;margin-top:20px;color:#666;font-size:12px">
          Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; Ø²ÙŠØ¯ Ø¹Ù„ÙŠ Ø§Ù„Ø¹Ù„ÙŠ 2026
        </p>
        </div></body></html>`;
      w.document.write(html); 
      w.document.close(); 
      w.print();
    }

    // ØªÙ†Ø³ÙŠÙ‚ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯
    function formatAppointmentDate(datetime){
      try {
        const dt = new Date(datetime);
        return dt.toLocaleString('ar-EG', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch(e) {
        return datetime;
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©
    function updateFees(id, amount){
      patients = patients.map(p => p.id === id ? {...p, fees: (p.fees||0) + Number(amount)} : p);
      save(); 
      render();
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function exportJSON(){
      const blob = new Blob([JSON.stringify(patients,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'dental_patients.json'; 
      a.click(); 
      URL.revokeObjectURL(url);
    }
    
    function exportCSV(){
      const header = ['id','name','phone','dob','status','lastVisit','fees','notes'].join(',');
      const rows = patients.map(p => [p.id, quote(p.name), quote(p.phone), p.dob||'', p.status||'', p.lastVisit||'', p.fees||0, quote(p.notes||'')].join(','));
      const csv = [header, ...rows].join('\n');
      const blob = new Blob([csv],{type:'text/csv'}); 
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'dental_patients.csv'; 
      a.click(); 
      URL.revokeObjectURL(url);
    }
    
    function quote(s){ return '"' + String(s||'').replace(/"/g,'""') + '"'; }

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    document.getElementById('newBtn').onclick = ()=> openForm();
    document.getElementById('backupBtn').onclick = ()=> exportJSON();
    document.getElementById('csvBtn').onclick = ()=> exportCSV();
    document.getElementById('downloadBackup').onclick = ()=> exportJSON();
    document.getElementById('resetDemo').onclick = ()=>{ 
      if (confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø«Ø§Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')){ 
        patients = SAMPLE.slice(); 
        save(); 
        render(); 
      } 
    };

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById('importFile').onchange = function(e){
      const f = e.target.files[0]; 
      if (!f) return;
      const r = new FileReader();
      r.onload = function(){ 
        try {
          const data = JSON.parse(r.result);
          if (!Array.isArray(data)) throw new Error('Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­');
          patients = data; 
          save(); 
          render(); 
          alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        } catch(err){ 
          alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + err.message); 
        } 
      };
      r.readAsText(f);
      // reset input
      e.target.value = '';
    };

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨
    [searchInput, statusFilter, sortBy].forEach(el => el.addEventListener('input', render));
    
    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    settingsBtn.onclick = function() {
      settingsMenu.classList.toggle('show');
    };
    
    // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', function(e) {
      if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
        settingsMenu.classList.remove('show');
      }
    });
    
    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù…Ø©
    document.querySelectorAll('.theme-option').forEach(opt => {
      opt.onclick = function() {
        appSettings.theme = this.dataset.theme;
        document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
      };
    });
    
    // Ø§Ø®ØªÙŠØ§Ø± Ø­Ø¬Ù… Ø§Ù„Ø®Ø·
    document.querySelectorAll('.font-size-btn').forEach(btn => {
      btn.onclick = function() {
        appSettings.fontSize = this.dataset.size;
        document.querySelectorAll('.font-size-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
      };
    });
    
    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    saveSettingsBtn.onclick = function() {
      appSettings.nightMode = nightModeToggle.checked;
      appSettings.notifications = notificationsToggle.checked;
      appSettings.advancedSearch = advancedSearchToggle.checked;
      saveSettings();
      settingsMenu.classList.remove('show');
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    };

    // Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ø·ÙˆØ±
    document.getElementById('developerBtn').onclick = function() {
      window.open('https://ornmo502.wordpress.com/', '_blank');
    };

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    load(); 
    render();

    // ØªØ¹Ø±ÙŠØ¶ Ø¨Ø¹Ø¶ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„ØªØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    window._dp = { patients, save, render, openForm, appSettings, saveSettings };

  </script>
</body>
</html>
